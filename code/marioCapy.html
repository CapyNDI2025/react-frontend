<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capy Mario - Mini Jeu R√©tro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Press Start 2P', monospace;
      background: linear-gradient(180deg, #5c94fc 0%, #5c94fc 70%, #8b5a00 70%, #8b5a00 100%);
      min-height: 100vh;
      overflow: hidden;
    }

    /* Game Container - Hidden by default */
    #gameContainer {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      animation: fadeIn 0.5s;
    }

    #gameContainer.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Game Canvas */
    #gameCanvas {
      background: linear-gradient(180deg, #5c94fc 0%, #5c94fc 70%, #8b5a00 70%, #8b5a00 100%);
      border: 8px solid #fff;
      box-shadow: 0 0 0 4px #000, 0 8px 32px rgba(0, 0, 0, 0.8);
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }

    /* HUD */
    #hud {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 12px;
      text-shadow: 2px 2px 0 #000;
      display: flex;
      gap: 40px;
      z-index: 10000;
    }

    .hud-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Instructions */
    #instructions {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 10px;
      text-align: center;
      text-shadow: 2px 2px 0 #000;
      z-index: 10000;
    }

    /* Easter Egg Indicator */
    #easterEggHint {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 8px;
      color: rgba(255, 255, 255, 0.3);
      font-family: monospace;
      z-index: 1;
    }

    /* Close Button */
    #closeBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #ff0000;
      color: white;
      border: 4px solid #fff;
      padding: 10px 20px;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      cursor: pointer;
      box-shadow: 0 4px 0 #8b0000;
      z-index: 10001;
    }

    #closeBtn:hover {
      background: #cc0000;
      transform: translateY(2px);
      box-shadow: 0 2px 0 #8b0000;
    }

    #closeBtn:active {
      transform: translateY(4px);
      box-shadow: none;
    }

    /* Game Over Screen */
    #gameOver {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 40px;
      border: 8px solid #fff;
      text-align: center;
      color: white;
      z-index: 10002;
    }

    #gameOver.show {
      display: block;
      animation: bounceIn 0.5s;
    }

    @keyframes bounceIn {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    #gameOver h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #ff0000;
    }

    #gameOver p {
      font-size: 14px;
      margin: 10px 0;
    }

    #restartBtn {
      margin-top: 20px;
      background: #00ff00;
      color: #000;
      border: 4px solid #fff;
      padding: 15px 30px;
      font-family: 'Press Start 2P', monospace;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 4px 0 #008b00;
    }

    #restartBtn:hover {
      background: #00cc00;
      transform: translateY(2px);
      box-shadow: 0 2px 0 #008b00;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
<!-- Easter Egg Hint -->
<div id="easterEggHint">Tape "capy" pour une surprise... ü¶´</div>

<!-- Game Container -->
<div id="gameContainer">
  <button id="closeBtn">‚úï FERMER</button>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-item">
      <span>ü¶´ VIE:</span>
      <span id="lives">3</span>
    </div>
    <div class="hud-item">
      <span>‚≠ê SCORE:</span>
      <span id="score">0</span>
    </div>
    <div class="hud-item">
      <span>‚è±Ô∏è TEMPS:</span>
      <span id="timer">60</span>
    </div>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" width="800" height="400"></canvas>

  <!-- Instructions -->
  <div id="instructions">
    ‚¨ÖÔ∏è A/Q | ‚û°Ô∏è D | ‚¨ÜÔ∏è SPACE/W/Z pour SAUTER | Collecte les üåü | √âvite les üî•
  </div>

  <!-- Game Over Screen -->
  <div id="gameOver">
    <h2>GAME OVER</h2>
    <p>Score Final: <span id="finalScore">0</span></p>
    <p id="message"></p>
    <button id="restartBtn">üîÑ REJOUER</button>
  </div>
</div>

<script>
  // =============================================
  // EASTER EGG DETECTION - "CAPY"
  // =============================================
  let typedKeys = '';
  const SECRET_CODE = 'capy';

  document.addEventListener('keypress', (e) => {
    typedKeys += e.key.toLowerCase();

    // Keep only last 4 characters
    if (typedKeys.length > SECRET_CODE.length) {
      typedKeys = typedKeys.slice(-SECRET_CODE.length);
    }

    // Check if secret code matches
    if (typedKeys === SECRET_CODE) {
      activateGame();
      typedKeys = ''; // Reset
    }
  });

  // =============================================
  // GAME ACTIVATION
  // =============================================
  function activateGame() {
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.classList.add('active');
    initGame();
    playSound('start');
  }

  // =============================================
  // GAME INITIALIZATION
  // =============================================
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // Game State
  let gameRunning = false;
  let score = 0;
  let lives = 3;
  let timeLeft = 60;
  let gameLoop;
  let timerInterval;

  // Player (Capybara)
  const player = {
    x: 100,
    y: 280,
    width: 40,
    height: 40,
    velocityY: 0,
    velocityX: 0,
    gravity: 0.8,
    jumpPower: -15,
    speed: 5,
    isJumping: false,
    direction: 1 // 1 = right, -1 = left
  };

  // Ground
  const ground = {
    y: 320,
    height: 80
  };

  // Obstacles & Collectibles
  let obstacles = [];
  let collectibles = [];
  let clouds = [];

  // Input handling
  const keys = {};
  document.addEventListener('keydown', (e) => {
    keys[e.key.toLowerCase()] = true;
    if ([' ', 'w', 'z'].includes(e.key.toLowerCase()) && !player.isJumping) {
      player.velocityY = player.jumpPower;
      player.isJumping = true;
      playSound('jump');
    }
  });
  document.addEventListener('keyup', (e) => {
    keys[e.key.toLowerCase()] = false;
  });

  // =============================================
  // GAME FUNCTIONS
  // =============================================
  function initGame() {
    gameRunning = true;
    score = 0;
    lives = 3;
    timeLeft = 60;
    obstacles = [];
    collectibles = [];
    clouds = [];

    player.x = 100;
    player.y = 280;
    player.velocityY = 0;
    player.velocityX = 0;
    player.isJumping = false;

    document.getElementById('gameOver').classList.remove('show');
    updateHUD();

    // Initialize clouds
    for (let i = 0; i < 5; i++) {
      clouds.push({
        x: Math.random() * canvas.width,
        y: Math.random() * 150 + 20,
        speed: Math.random() * 0.5 + 0.2,
        size: Math.random() * 30 + 20
      });
    }

    // Start game loop
    gameLoop = requestAnimationFrame(update);

    // Start timer
    timerInterval = setInterval(() => {
      if (gameRunning) {
        timeLeft--;
        updateHUD();
        if (timeLeft <= 0) {
          endGame('Temps √©coul√©!');
        }
      }
    }, 1000);

    // Spawn obstacles and collectibles
    setInterval(() => {
      if (gameRunning && Math.random() < 0.3) {
        spawnObstacle();
      }
    }, 2000);

    setInterval(() => {
      if (gameRunning && Math.random() < 0.5) {
        spawnCollectible();
      }
    }, 1500);
  }

  function update() {
    if (!gameRunning) return;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw sky
    drawSky();

    // Draw clouds
    updateClouds();

    // Draw ground
    drawGround();

    // Update player
    updatePlayer();

    // Update and draw obstacles
    updateObstacles();

    // Update and draw collectibles
    updateCollectibles();

    // Draw player
    drawPlayer();

    // Continue loop
    gameLoop = requestAnimationFrame(update);
  }

  function drawSky() {
    const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height * 0.7);
    gradient.addColorStop(0, '#5c94fc');
    gradient.addColorStop(1, '#3a7bd5');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height * 0.7);
  }

  function drawGround() {
    // Dirt
    ctx.fillStyle = '#8b5a00';
    ctx.fillRect(0, ground.y, canvas.width, ground.height);

    // Grass
    ctx.fillStyle = '#2d7f2f';
    ctx.fillRect(0, ground.y, canvas.width, 10);

    // Grass details
    for (let i = 0; i < canvas.width; i += 20) {
      ctx.fillStyle = '#4caf50';
      ctx.fillRect(i, ground.y, 4, 8);
      ctx.fillRect(i + 8, ground.y, 4, 6);
    }
  }

  function updateClouds() {
    clouds.forEach(cloud => {
      cloud.x -= cloud.speed;
      if (cloud.x < -cloud.size) {
        cloud.x = canvas.width + cloud.size;
      }

      // Draw cloud
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      ctx.beginPath();
      ctx.arc(cloud.x, cloud.y, cloud.size, 0, Math.PI * 2);
      ctx.arc(cloud.x + cloud.size * 0.5, cloud.y, cloud.size * 0.7, 0, Math.PI * 2);
      ctx.arc(cloud.x - cloud.size * 0.5, cloud.y, cloud.size * 0.7, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  function updatePlayer() {
    // Horizontal movement
    if (keys['d'] || keys['arrowright']) {
      player.velocityX = player.speed;
      player.direction = 1;
    } else if (keys['a'] || keys['q'] || keys['arrowleft']) {
      player.velocityX = -player.speed;
      player.direction = -1;
    } else {
      player.velocityX *= 0.8; // Friction
    }

    player.x += player.velocityX;

    // Keep player in bounds
    if (player.x < 0) player.x = 0;
    if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;

    // Gravity
    player.velocityY += player.gravity;
    player.y += player.velocityY;

    // Ground collision
    if (player.y >= ground.y - player.height) {
      player.y = ground.y - player.height;
      player.velocityY = 0;
      player.isJumping = false;
    }
  }

  function drawPlayer() {
    // Capybara body (pixel art style)
    ctx.fillStyle = '#8B4513';

    // Body
    ctx.fillRect(player.x + 8, player.y + 10, 24, 20);

    // Head
    ctx.fillRect(player.x + 20, player.y, 16, 16);

    // Ears
    ctx.fillRect(player.x + 20, player.y - 4, 4, 4);
    ctx.fillRect(player.x + 32, player.y - 4, 4, 4);

    // Eyes
    ctx.fillStyle = '#000';
    if (player.direction === 1) {
      ctx.fillRect(player.x + 28, player.y + 4, 3, 3);
      ctx.fillRect(player.x + 32, player.y + 4, 2, 2);
    } else {
      ctx.fillRect(player.x + 22, player.y + 4, 3, 3);
      ctx.fillRect(player.x + 26, player.y + 4, 2, 2);
    }

    // Nose
    ctx.fillStyle = '#654321';
    ctx.fillRect(player.x + 34, player.y + 10, 3, 2);

    // Legs
    ctx.fillStyle = '#654321';
    ctx.fillRect(player.x + 10, player.y + 30, 6, 10);
    ctx.fillRect(player.x + 24, player.y + 30, 6, 10);

    // Tail
    ctx.fillRect(player.x + 4, player.y + 20, 4, 4);
  }

  function spawnObstacle() {
    obstacles.push({
      x: canvas.width,
      y: ground.y - 30,
      width: 30,
      height: 30,
      speed: 4 + Math.random() * 2
    });
  }

  function updateObstacles() {
    for (let i = obstacles.length - 1; i >= 0; i--) {
      const obs = obstacles[i];
      obs.x -= obs.speed;

      // Draw obstacle (fire)
      ctx.fillStyle = '#ff4500';
      ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
      ctx.fillStyle = '#ff6347';
      ctx.fillRect(obs.x + 5, obs.y + 5, 20, 15);
      ctx.fillStyle = '#ffa500';
      ctx.fillRect(obs.x + 10, obs.y + 10, 10, 10);

      // Check collision
      if (checkCollision(player, obs)) {
        obstacles.splice(i, 1);
        lives--;
        updateHUD();
        playSound('hit');

        if (lives <= 0) {
          endGame('Plus de vies!');
        }
        continue;
      }

      // Remove if off screen
      if (obs.x < -obs.width) {
        obstacles.splice(i, 1);
      }
    }
  }

  function spawnCollectible() {
    collectibles.push({
      x: canvas.width,
      y: ground.y - 80 - Math.random() * 100,
      width: 20,
      height: 20,
      speed: 3
    });
  }

  function updateCollectibles() {
    for (let i = collectibles.length - 1; i >= 0; i--) {
      const col = collectibles[i];
      col.x -= col.speed;

      // Draw collectible (star)
      ctx.fillStyle = '#ffd700';
      ctx.beginPath();
      for (let j = 0; j < 5; j++) {
        const angle = (j * 4 * Math.PI) / 5 - Math.PI / 2;
        const x = col.x + col.width/2 + Math.cos(angle) * col.width/2;
        const y = col.y + col.height/2 + Math.sin(angle) * col.height/2;
        if (j === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.fill();

      // Check collision
      if (checkCollision(player, col)) {
        collectibles.splice(i, 1);
        score += 10;
        updateHUD();
        playSound('collect');
        continue;
      }

      // Remove if off screen
      if (col.x < -col.width) {
        collectibles.splice(i, 1);
      }
    }
  }

  function checkCollision(rect1, rect2) {
    return rect1.x < rect2.x + rect2.width &&
            rect1.x + rect1.width > rect2.x &&
            rect1.y < rect2.y + rect2.height &&
            rect1.y + rect1.height > rect2.y;
  }

  function updateHUD() {
    document.getElementById('lives').textContent = lives;
    document.getElementById('score').textContent = score;
    document.getElementById('timer').textContent = timeLeft;
  }

  function endGame(message) {
    gameRunning = false;
    clearInterval(timerInterval);
    cancelAnimationFrame(gameLoop);

    document.getElementById('finalScore').textContent = score;
    document.getElementById('message').textContent = message;
    document.getElementById('gameOver').classList.add('show');

    playSound('gameOver');
  }

  // =============================================
  // SOUND EFFECTS (8-bit style)
  // =============================================
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();

  function playSound(type) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);

    switch(type) {
      case 'jump':
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
        break;
      case 'collect':
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
        break;
      case 'hit':
        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        break;
      case 'start':
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        break;
      case 'gameOver':
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.5);
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        break;
    }
  }

  // =============================================
  // BUTTON CONTROLS
  // =============================================
  document.getElementById('closeBtn').addEventListener('click', () => {
    document.getElementById('gameContainer').classList.remove('active');
    gameRunning = false;
    clearInterval(timerInterval);
    cancelAnimationFrame(gameLoop);
  });

  document.getElementById('restartBtn').addEventListener('click', () => {
    initGame();
  });
</script>
</body>
</html>